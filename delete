#!/bin/bash
set -e

if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <file_list_path> <destination_bucket>"
    exit 1
fi

file_list="$1"
destination_bucket="$2"
log_file="copy_results.csv"

# Create or reset the log file
echo "Timestamp,Source,Destination,Status" > "$log_file"

# Read each S3 path from the input file
while IFS= read -r raw_source; do
    # Skip empty lines
    [ -z "$raw_source" ] && continue

    # Clean CRLF (Windows line endings)
    source=$(echo "$raw_source" | tr -d '\r')

    # Normalize uppercase S3:// â†’ lowercase s3://
    source=$(echo "$source" | sed 's/^S3:\/\//s3:\/\//')

    # Extract filename safely
    filename=$(basename "$source")

    # Build destination S3 path
    destination="s3://$destination_bucket/$filename"

    echo "Copying: $source â†’ $destination"

    # Use quotes inside aws command to handle special characters (:, spaces, etc.)
    if aws s3 cp "$source" "$destination" --quiet --no-guess-mime-type; then
        echo "$(date '+%Y-%m-%d %H:%M:%S'),\"$source\",\"$destination\",Success" >> "$log_file"
        echo "âœ… Success: $filename"
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S'),\"$source\",\"$destination\",Failed" >> "$log_file"
        echo "âŒ Failed: $filename" >&2
    fi

done < "$file_list"

echo ""
echo "ðŸ“„ Copy completed. Log saved to: $log_file"
