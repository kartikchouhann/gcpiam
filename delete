for stack in $(aws cloudformation list-stacks \
  --stack-status-filter DELETE_FAILED \
  --query "StackSummaries[].StackName" \
  --output text); do

  echo "üîç Checking stack: $stack"

  # Get only buckets in DELETE_FAILED (not DELETE_COMPLETE)
  buckets=$(aws cloudformation describe-stack-resources --stack-name "$stack" \
    --query "StackResources[?ResourceType=='AWS::S3::Bucket' && ResourceStatus=='DELETE_FAILED'].PhysicalResourceId" \
    --output text)

  if [ -n "$buckets" ]; then
    echo "ü™£ Retaining buckets: $buckets"
    aws cloudformation delete-stack --stack-name "$stack" --retain-resources $buckets || true
  else
    echo "üßπ No S3 buckets to retain ‚Äî performing normal delete"
    aws cloudformation delete-stack --stack-name "$stack" || true
  fi
done
