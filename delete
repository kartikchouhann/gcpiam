#!/bin/bash

for stack in $(aws cloudformation list-stacks \
  --stack-status-filter DELETE_FAILED \
  --query "StackSummaries[].StackName" \
  --output text); do

  echo "🔍 Checking stack: $stack"

  # Get only buckets still in DELETE_FAILED (not DELETE_COMPLETE)
  buckets=$(aws cloudformation describe-stack-resources --stack-name "$stack" \
    --query "StackResources[?ResourceType=='AWS::S3::Bucket' && ResourceStatus=='DELETE_FAILED'].PhysicalResourceId" \
    --output text)

  if [ -n "$buckets" ]; then
    echo "🪣 Found DELETE_FAILED buckets: $buckets"
    echo "   -> Emptying buckets before retry..."
    for bucket in $buckets; do
      aws s3 rm s3://$bucket --recursive --quiet || true
      # Also delete versions if versioning was on
      aws s3api list-object-versions --bucket "$bucket" --output json \
        --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' | \
        jq -e '.Objects | length > 0' >/dev/null 2>&1 && \
        aws s3api delete-objects --bucket "$bucket" \
          --delete "$(aws s3api list-object-versions --bucket "$bucket" \
          --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' --output json)" || true
    done

    echo "🧹 Retrying delete for $stack"
    aws cloudformation delete-stack --stack-name "$stack" || true
  else
    echo "✅ No failed S3 buckets found — direct delete"
    aws cloudformation delete-stack --stack-name "$stack" || true
  fi
done
